{% set n = (node_parser(node)) %}
{% set client = node_parser(n.field_client.nid) %}
{% set status = n.field_status %}
{#{{kint(n.field_articles[0])}} {{die()}}#}
{% set params = get_parameter() %}
{{ attach_library('myadmin/bootstrap_css') }}
{{ attach_library('myadmin/jquery_confirm') }}
{% set montant_argent_input = params.montant_argent_input %}
<style>
.bg-gin{
  background-color:var(--colorGinToolBarBackground);
}
.text-custom-payed{
  color:#28a745;
    text-transform: uppercase;
}
.text-custom-unpayed{
  color:#d2322d;
    text-transform: uppercase;
}
.text-custom-cancel{
  color:#6c6c6c;
    text-transform: uppercase;
}
.hidden{
   display:none;
}
.ctll{
    height: 40px;
    background-color: #dedede;
}
#invoice{
  margin-top: -80px;
}
.red_color{
  color:red ;
}
</style>
<div class="container">
  <section id="invoice">
    <div class="container my-md-5 py-5">

      <div class=" d-md-flex justify-content-between align-items-center  mb-5  ">
        <div class="mt-5 mt-md-0">
          <h2 class="display-6 fw-bold">Commande </h2>
          <p class="m-0">Reference : {{ n.title }}</p>
        </div>
        <div class="mt-5 mt-md-0 me-5">
          {% if n.field_status == "payed" %}
             <h5 class="text-custom-payed fw-bold">Commande payé  </h5>
          {% endif %}
          {% if n.field_status == "unpayed" %}
             <h5 class="text-custom-unpayed fw-bold"> En Attente de paiement  </h5>
          {% endif %}
          {% if n.field_status == "cancel" %}
             <h5 class="text-custom-cancel fw-bold">Commande Annulé  </h5>
          {% endif %}
        </div>
      </div>

      <div class="bg-gin rounded-5 p-5">
        <div class="d-md-flex justify-content-between">
          <div>
           {% if client %}
            <p class="text-primary fw-bold">Info client</p>
            <h5>{{ client.title }}</h5>
            <p>{{ client.field_phone }}</p>
           {% endif %}
          </div>
          <div class="text-md-end ">
            <p class="text-primary fw-bold">Info commande</p>
            <h5>Date</h5>
            <ul class="list-unstyled">
              <li><span class="fw-semibold">Antananarivo, le </span> {{ n.created |date('d-m-Y') }}</li>
            </ul>
          </div>
        </div>
      </div>



      <table class="table border my-4">
        <thead>
        <tr class="bg-primary">
          <th scope="col">Description</th>
          <th scope="col">Prix unitaire</th>
          <th scope="col">Qte</th>
          <th scope="col">Montant</th>
        </tr>
        </thead>
        <tbody>
        {% set total = 0 %}
           {% set total_tva  = 0 %}
        {% for article in n.field_articles %}
          {% set a = node_parser(article.field_article.nid) %}
          {% set montant = a.field_prix_unitaire * article.field_quantite %}

          <tr>
            <td>{{ a.title }} {% if (a.field_tva == 1) %} ( Avec TVA ){% endif %} </td>
            <td>{{ price(a.field_prix_unitaire) }} Ar</td>
            <td>{{ article.field_quantite }}</td>
            <td>{{ price(montant) }} Ar</td>
          </tr>
          {% if (a.field_tva == 1) %}
           {% set total_tva = total_tva + montant*0.20 %}
          {% endif %}
            {% set total = total +  montant %}
        {% endfor %}
        <tr>
          <td></td>
          <td></td>
          <td class="fw-bold">Sous total</td>
          <td class="fw-bold">{{ price(total) }} Ar</td>
        </tr>
        {% if (total_tva > 0) %}
        <tr>
          <td></td>
          <td></td>
          <td class="fw-bold">TVA </td>
          <td class="fw-bold">{{price(total_tva)}} Ar </td>
        </tr>
        {% endif %}
        {% if n.field_remise %}
        <tr>
          <td></td>
          <td></td>
          <td class="fw-bold">Total</td>
          <td class="fw-bold">{{ price(total_tva + total) }} Ar</td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="fw-bold">Remise</td>
          <td class="fw-bold">{{ n.field_remise }} %</td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="text-primary fs-5 fw-bold">Total</td>
          <td class="text-primary fs-5 fw-bold">{{ price((total_tva + total)*(1-(n.field_remise)/100)) }} Ar</td>
          <input type="hidden" id="mytotal" value="{{total_tva + total}}" />
        </tr>
        {% else %}
        <tr id="remise-dynamique"></tr>
        <tr id="total-dynamique">
          <td></td>
          <td></td>
          <td class="text-primary fs-5 fw-bold">Total</td>
          <td class="text-primary fs-5 fw-bold">{{ price(total_tva + total) }} Ar</td>
           <input type="hidden" id="mytotal" value="{{total_tva + total}}" />
        </tr>
        {% endif %}
        </tbody>
      </table>

      <div class="rounded-5">
        {% if n.field_status == "unpayed" %}
        <label for="remise-select" class="form-label">Remise</label>
        <select class="form-select w-25" aria-label="Default select example" id="remise-select">
          <option selected value="">------</option>
          <option value="5">5%</option>
          <option value="10">10%</option>
        </select>
        {% endif %}
        <div class="d-md-flex justify-content-between mt-4">
          <div class="mt-5 mt-md-0">
            {% if n.field_status == "unpayed" %}
              <div class="d-flex">
                <button type="button" id="click_pay_confirm" class="btn btn-primary">Confirmez payement</button>
                <form id="confirm_pay" class="hidden" action="" method="POST" onsubmit="return confirm('Voulez-vous vraiment confirmer la commande?');" class="mx-2">
                  <input type="hidden" name="status" value="payed" />
                  <input type="hidden" name="remise" id="remise-input">
                  <input type="hidden" name="montant_argent_input" id="montant_argent_input">
                  <button type="submit" class="btn btn-danger">Confimez Maintenant</button>
                </form>
                <form action="" method="POST" onsubmit="return confirm('Voulez-vous vraiment annuler la commande?');" class="mx-2">
                  <input type="hidden" name="status" value="cancel" />
                  <button type="submit" class="btn btn-secondary">Annuler la Commande </button>
                </form>
                <a class=" btn btn-secondary float-end"  href="/{{current_url()}}" > Retour  <a>
      
              </div>
            {% endif %}
            {% if n.field_status == "payed" %}
                <input type="hidden" name="telecharger" value="1" />
              
                <a target="_blank" href="/ticket?id={{n.nid}}&montant_argent_input={{montant_argent_input}}" class="btn btn-primary">Télécharger ticket de caisse</a>
                <a target="_blank" href="/invoice?id={{n.nid}}&montant_argent_input={{montant_argent_input}}" class="btn btn-primary">Télécharger la facture </a>

                <form action="" method="POST" onsubmit="return confirm('Voulez-vous vraiment annuler la commande?');" class="mx-2">
                  <input type="hidden" name="status" value="cancel" />
                  <button type="submit" class="btn btn-secondary">Annuler la Commande </button>
                </form>
            {% endif %}
          </div>
          <div class="text-md-end mt-5 mt-md-0">

          </div>
        </div>
      </div>

    </div>
  </section>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<script>
     {# function MyPopUpWin(url, width, height) {
            var leftPosition, topPosition;
            //Allow for borders.
            leftPosition = (window.screen.width / 2) - ((width / 2) + 10);
            //Allow for title and status bars.
            topPosition = (window.screen.height / 2) - ((height / 2) + 50);
            //Open the window.
            window.open(url, "Window2",
            "status=no,height=" + height + ",width=" + width + ",resizable=no,left="
            + leftPosition + ",top=" + topPosition + ",screenX=" + leftPosition + ",screenY="
            + topPosition + ",toolbar=no,menubar=no,scrollbars=no,location=no,directories=no");
        } #}
  var total = {{ total_tva + total }};
  $('input:radio[name="remise"]').change(
    function(){
      if ($(this).is(':checked')) {
        $('#remise-submit').prop('disabled',false);
      }
    });
  $('#remise-form').submit(function() {
    var c = confirm("Appliquer une remise de "+$('input:radio[name="remise"]:checked').val()+"% ?");
    return c;
  });
  $('#remise-select').change(function (){
    $('#remise-input').val($(this).val());
    let with_remise = Math.round(total*(1- ($(this).val())/100));

    
    if($(this).val()){
      $('#remise-dynamique').html('<td></td>'+
        '<td></td>'+
      '<td class="fw-bold">Remise</td>'+
      '<td class="fw-bold">'+$(this).val()+'%</td>');
      $('#total-dynamique').html('<td></td>'+
        '<td></td>'+
      '<td class="text-primary fs-5 fw-bold">Total</td>'+
      '<td class="text-primary fs-5 fw-bold">'+ with_remise +' Ar</td>'+
      '<input type="hidden" id="mytotal" value="'+ with_remise +'" />'
      );
    }else{
      $('#remise-dynamique').html('');

      $('#total-dynamique').html('<td></td>'+
        '<td></td>'+
        '<td class="text-primary fs-5 fw-bold">Total</td>'+
        '<td class="text-primary fs-5 fw-bold">'+ total+' Ar</td>'+
        '<input type="hidden" id="mytotal" value="'+total+'" />'
        );
    }
  })
 function formatNumber(number) {
        return new Intl.NumberFormat('fr-FR').format(number);
      }


  		$('#click_pay_confirm').on('click', function () {
              var jstotal = Math.round($('#mytotal').val());
            
							$.confirm({
								title: 'Calculation',
							  content: '' +
                '<form action="" class="formName">' +
                '<div class="form-group">' +
                '<label> Total de l\'Achat </label>' +
                '<p class="ctll form-control" required> <span class="jstotal">'+ (jstotal) +'</span> Ar </p>' +
                '<label> Veuillez entrer le montant d\'argent du client </label>' +
                '<input class="montant_argent form-control" required  /><br/>' +    
                '<label> Retour de la monnaie </label>' +  
                '<p class="montant_reste ctll form-control" required ></p><br/>' +   
                '</div>' +
                '</form>',
		           buttons: {
                    submitPay : {
                        text: 'Confirmez Maintenant',
                        btnClass: 'btn-blue',
                        keys: ['enter', 'shift'],
                        action: function(){
                            var montant_argent = this.$content.find('.montant_argent').val();
                            var rest = (montant_argent - jstotal) ;
                            this.$content.find('.montant_reste').html(formatNumber(rest));
                            $('#montant_argent_input').val(montant_argent);
                            if(rest < 0){
                               this.$content.find('.montant_reste').addClass('red_color');
                            }else{
                               if(confirm('Voulez-vous vraiment confirmer la commande?')){
                                                  $('#confirm_pay')[0].submit(); 
                                }
                                                 
                                                
                            }
                             return false ;
                  
                        }
                    },
                    somethingElse: {
                        text: 'Calculer',
                        btnClass: 'btn-blue',
                        keys: ['enter', 'shift'],
                        action: function(){
                              var montant_argent = this.$content.find('.montant_argent').val();
                              var rest = (montant_argent - jstotal) ;
                              if(rest < 0){
                               this.$content.find('.montant_reste').addClass('red_color');
    
                               }
                              $('#montant_argent_input').val(montant_argent);
                              this.$content.find('.montant_reste').html(formatNumber(rest));
                              
                              return false;
                          
                        }
                    }
                },
		            backgroundDismiss: false,
		            closeIcon: true,
							});
				});
</script>
